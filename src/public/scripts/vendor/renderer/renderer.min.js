define(["jquery","underscore","backbone","cookies","util","when"],function(e,t,a,s,r,i){function o(){this.widgetPath=e("widget").attr("base-path"),this.serializeFormAsObject=r.serializeFormAsObject,this.destroy=function(){this.unbind(),this.undelegateEvents(),void 0!=this.model&&void 0!=this.model.unbind&&this.model.unbind(),this.$el.remove(),this.remove()},this.listenFor=function(e,t){this.listenTo(a.EventBus,e,t)},this.fire=function(e,t){0==this.allWidgetsLoaded?(logger.debug("storing event ",e),this.eventStack.push({name:e,data:t})):a.EventBus.trigger(e,t)},this.currentLayout=function(){return a.currentLayout},this.loadTemplate=function(e,t){a.loadTemplate(e,t,this)},this.when=i,this.clean=!1,this.sourceFolder=function(){return this.options.src.substring(0,this.options.src.lastIndexOf("/"))},this.assetsFolder=function(){return this.sourceFolder()+"/assets/"},this.asset=function(e){return this.assetsFolder()+e},this.appendTemplate=function(e){void 0==e.context&&(e.context=this);var t=function(a){0!=a.length?e.context.renderTemplate({template:e.template,data:a[0],el:e.el,append:!0,renderCallback:function(){a.shift(),t.call(e.context,a)}}):void 0!==e.callback&&e.callback.call(e.context)},a=JSON.parse(JSON.stringify(e.data));t(a)},this.renderTemplate=function(s){function o(s,i){var o=e("<div/>");s.html=s.html.replace(/src/g,"__wtf__");var n=e(r.trim(s.html));o.append(n);var l=s.context;t.each(o.find("[asset]"),function(t){var a=e(t).attr("asset");a=this.assetsFolder()+a,e(t).attr("src",a),e(t).removeAttr("asset")},s.context),o.html(o.html().replace(new RegExp("({{)\\s+","g"),"$1")),o.html(o.html().replace(new RegExp("\\s+(}})","g"),"$1"));for(var d=o.find("[iterate]"),c=d.length,u=0;c>u;){var v=e(d[u]).find("[iterate]");if(v.length>0)for(var p=v.length,h=0;p>h;){child=v[h];var m=e(child).attr("iterate");-1==m.indexOf("element.")&&(m="element."+m,e(child).attr("iterate",m)),h++}u++}for(var f=o.find("[iterate]"),h=0;h<f.length;h++){f=o.find("[iterate]");var g=f[h],x=e(g).attr("iterate");e(g).before("{= _.each("+x+", function(element)  {  =}"),e(g).after("{=  } );  =}"),k=e(g).html();var b=new RegExp("{{([a-zA-Z\\d ,._ 0-9 \\[ \\]]+)}}","g"),y="{{element.$1}}",w=new RegExp("\\[\\[([0-9]+)\\]\\]","g"),T="{{element[$1]}}";-1==k.indexOf("{{element.")&&e(g).html(r.trim(k.replace(b,y))),k=e(g).html(),-1==k.indexOf("{{element.")&&e(g).html(r.trim(k.replace(w,T))),e.each(g.attributes,function(t,a){var s=e(g).attr(a.name),i=r.trim(s.replace(b,y));s=s==i?r.trim(s.replace(w,T)):i,e(g).attr(a.name,s)})}if(n=o.html(),n=n.replace(/__wtf__/g,"src"),void 0!==s.webservice)l.ajaxRequest({url:s.webservice,data:s.params,type:s.type,dataType:"json",error:s.error,saveAs:s.saveAs,saveFrom:s.saveFrom,success:function(r){void 0!==s.serviceCallback&&(r=s.serviceCallback.call(s.context,r));var o=t.template(n,r);void 0==s.append?s.el.html(o):1==s.append?s.el.append(o):1==s.prepend&&s.el.prepend(o),void 0!==s.renderCallback&&s.renderCallback.call(s.context),a.constructor.createWidgetsInEl(e(s.el)),i.resolve()}});else{var k=null;k=void 0==s.data?t.template(n):t.template(n,s.data),void 0==s.append?s.el.html(k):s.el.append(k),void 0!==s.renderCallback&&s.renderCallback.apply(s.context),a.constructor.createWidgetsInEl(e(s.el)),i.resolve()}}var n=i.defer();if(0==this.template&&"template"==s.template&&alert(this.cid+" "+s.template+".html - not loaded! When you use template = false, you have to choose different name for template in renderTemplate function."),void 0==s.template&&void 0==s.html&&alert("you need to provide ether html or template for the renderTemplate to work"),void 0==s&&(s={}),s.el=void 0==s.el?this.$el:e(s.el),0==s.el.length&&alert("Please provide a correct selector for the render template function"),void 0!==s.path&&(s.webservice=this.path(s.path)),void 0!==s.asset&&(s.webservice=this.assetsFolder()+s.asset),void 0!==s.webservice&&void 0===s.error&&(s.error=function(e){this.alert("invalid.session"==e.data||"not.logged"==e.data?{type:"danger",title:"Webservice "+s.webservice+" error:",message:"Your session is expired, please login again!",redirect:!0}:{type:"danger",title:"Webservice "+s.webservice+" error:",message:e.data})}),void 0===s.context&&(s.context=this),void 0!=s.template){("template"==s.template||"__empty__"==s.template)&&(s.renderCallback=function(){if(void 0!=s.context.listen)for(p in s.context.listen)s.context.listenFor(p,s.context[s.context.listen[p]]);void 0!==s.context.options.callbackTemplateFirstRender&&(s.context.options.callbackTemplateFirstRender(context),void 0==s.context.options.callbackTemplateFirstRender),void 0!==s.context.loaded&&(s.context.options.deffered.resolve(s.context),s.context.loaded())});var l=null;l="__empty__"==s.template?s.template:this.assetsFolder()+s.template+".html",a.loadTemplate(l,function(e){return s.html=e,o(s,n)})}else if(void 0!==s.html)return o(s,n);return n.promise},this.response=null,this.call=function(s){void 0!==s.template&&(s.asset=s.template,void 0===s.dataType&&(s.dataType="html")),void 0===s.asset&&(s.preloaderGuid=this.addPreloader()),void 0!==s.params&&(s.data=s.params),void 0===s.type&&(s.type="POST"),void 0===s.dataType&&(s.dataType="json"),void 0==s.context&&(s.context=this),void 0!==s.path&&(s.url=this.path(s.path)),void 0!==s.asset&&(s.url=this.assetsFolder()+s.asset),void 0==s.data&&(s.data={}),t.extend(s.data,{sid:a.session.sessionId}),void 0!==a.session&&void 0!==a.session.bpId&&t.extend(s.data,{bpId:a.session.bpId}),void 0!==a.session&&void 0!==a.session.shopId&&t.extend(s.data,{shopId:a.session.shopId}),void 0!==a.session&&void 0!==a.session.language&&t.extend(s.data,{lang:a.session.language}),void 0!==a.session&&void 0!==a.session.currency&&t.extend(s.data,{cur:a.session.currency}),void 0!=this.widgetPath&&(s.url=this.widgetPath+s.url);var r=e.ajax(s);"undefined"!=typeof s.cancelable&&s.cancelable===!0&&a.cancelableRequests.push(r);var o=i.defer(),n=o.promise;return n.ensure(function(){s.context.removePreloader(s.preloaderGuid)}),r.then(function(e){void 0!==e.status&&"error"===e.status?("invalid.session"==e.data||"not.logged"==e.data?s.context.alert({type:"danger",title:"Webservice "+s.url+" error:",message:"Your session is expired, please login again!",redirect:!0}):0!=s.alert&&n.otherwise(function(e){s.context.alert({type:"danger",title:"Webservice "+s.url+" error:",message:e})}),o.reject(e.data)):o.resolve(void 0!==e.data?e.data:e)},function(e){n.otherwise(function(e){0!=e.status&&s.context.alert({type:"danger",title:"Webservice "+s.url+" error:",message:"Server responded with "+e.status+" "+e.statusText})}),o.reject(e)}),n},this.ajaxRequest=function(s){s.preloaderGuid=this.addPreloader(),void 0===s.timeout&&(s.timeout=a.timeout),void 0!==s.params&&(s.data=s.params),void 0===s.type&&(s.type="POST"),void 0===s.dataType&&(s.dataType="json"),void 0==s.context&&(s.context=this),void 0!==s.path&&(s.url=this.path(s.path)),void 0!==s.asset&&(s.url=this.assetsFolder()+s.asset),void 0==s.data&&(s.data={}),void 0!==a.session&&void 0!==a.session.bpId&&t.extend(s.data,{bpId:a.session.bpId}),void 0!==a.session&&void 0!==a.session.shopId&&t.extend(s.data,{shopId:a.session.shopId}),void 0!==a.session&&void 0!==a.session.language&&t.extend(s.data,{lang:a.session.language}),void 0!==a.session&&void 0!==a.session.currency&&t.extend(s.data,{cur:a.session.currency}),void 0!=a.session.sessionId&&t.extend(s.data,{sid:a.session.sessionId});var i=s.success;if(void 0==s.error)s.error=function(e){var t=null;t=void 0==e.data?"Server responded with "+e.status+" "+e.statusText:e.data,this.alert("invalid.session"==t||"not.logged"==t?{type:"danger",title:"Webservice "+s.url+" error:",message:"Your session is expired, please login again!",redirect:!0}:{type:"danger",title:"Webservice "+s.url+" error:",message:t})};else{var o=s.error;s.error=function(e){var t=null;t=void 0!==e.status&&void 0!==e.statusText?"Server responded with "+e.status+" "+e.statusText:e,o.call(s.context,t)}}s.success=function(e){var t=null;if(void 0!==e.data?(t="data.",toStore=e.data):(t="",toStore=e),void 0!==s.saveAs){var a=s.saveAs;void 0!==s.saveFrom?(t+=s.saveFrom,this[a]=r.getPropByString(toStore,t)):this[a]=toStore}"error"==e.status&&s.error.call(s.context,e),void 0!==status&&"error"!==e.status&&void 0!=i&&i.call(s.context,toStore)},void 0!=this.widgetPath&&(s.url=this.widgetPath+s.url);var n=e.ajax(s);return"undefined"!=typeof s.cancelable&&s.cancelable===!0&&a.cancelableRequests.push(n),n.always(function(){s.context.removePreloader(s.preloaderGuid)}),n},this.request=function(){a.request={};var s=window.location.hash;if(void 0!=s&&""!=s){var r=s.split("/")[1];if(void 0!=r){var i=r.split("&");t.each(i,function(t){var s=t.split("="),r='{"'+s[0]+'":"'+s[1]+'"}';e.extend(a.request,jQuery.parseJSON(r))})}}return a.request},this.setSession=function(e){return void 0!==e&&(a.session=e),a.session},this.getSession=function(){return a.session},this.addPreloader=function(){a.preloaderCounter+=1,a.preloaderCounter>5&&(a.preloaderCounter=0);var t=r.guid(),s=e("<div>",{id:t,"class":"linearPreloader preloader"+a.preloaderCounter});return e("#preloader").append(s),s.animate({width:"100%"},{duration:a.timeout,progress:function(e){s.hasClass("loaded")&&(s.removeClass("loaded"),e.duration=e.duration/100)},complete:function(){s.fadeOut("fast",function(){s.remove()})}}),t},this.removePreloader=function(t){e("#"+t).addClass("loaded"),void 0!=this.$el&&this.$el.find(".trianglePreloader").parent().remove(),0!=a.preloaderCounter&&(a.preloaderCounter-=1,this.fire(0==a.preloaderCounter?"LAST_PRELOADER_FINISHED":"PRELOADER_FINISHED"))},this.deleteCookie=function(e){this.setCookie(e,void 0,{expires:1})},this.setCookie=function(e,t,a){s.set(e,t,a)},this.readCookie=function(e){return s.get(e)},this.validateInput=function(t,a){var s=e(t).val();switch(a){case"text":if(s.length>1)return!0;break;case"warning":e(targetElement).find(".alert").addClass("alert-block");break;case"success":e(targetElement).find(".alert").addClass("alert-success");break;default:e(targetElement).find(".alert").addClass("alert-info")}},this.path=function(e){if(void 0!==this.options.paths){var a=t.findWhere(this.options.paths,{name:e});return void 0==a?e:a.url}return e},this.navigate=function(e){if(void 0!==this.options&&void 0!==this.options.routes){var s=t.findWhere(this.options.routes,{name:e});if(void 0!=s)switch(s.action){case"alert":this.alert({message:s.value});break;case"changeLayout":a.router.navigate(s.value,!0);break;case"modal":break;case"modallayout":}}},this.alert=function(t){if("Your session is expired, please login again!"==t.message)return void 0==window.redirectingToHome&&(alert("Your session is expired, please login again!"),window.location="",window.location.reload()),void(window.redirectingToHome=!0);(void 0==t||null==t)&&(t={});var s="body",r="Info: ",i="No message to display",o="info",n=!0,l=3e5;void 0!=t.duration&&(l=t.duration);var d=!1;void 0!=t.redirect&&null!=t.redirect&&(d=t.redirect),void 0!=t.el&&null!=t.el&&(s=t.el),void 0!=t.title&&null!=t.title&&(r=t.title+"  :  "),void 0!=t.message&&null!=t.message&&(i=t.message),void 0==t.type&&(t.type="info"),null!=t.type&&(o=t.type),void 0!=t.autohide&&null!=t.autohide&&(n=t.autohide),void 0!=t.duration&&null!=t.duration&&(l=t.duration);var c=null;c=0==e("#alertContainer").length?e("<div>",{id:"alertContainer","class":"alert-container"}):e("#alertContainer");var u=e("<div>",{"class":"alert"}),v="<button id='alert_button' type='button' class='close' data-dismiss='alert'>Ã—</button><strong>"+r+"</strong>"+i;u.append(v),c.append(u),e(s).prepend(c),e(s).find(".alert").addClass("alert-"+o),1==n?window.setTimeout(function(){u.fadeOut("normal",function(){u.remove(),0==c.find(".alerts").length&&c.remove(),d&&(""==a.history.fragment||(window.location=""))})},l):u.find("#alert_button").on("click",function(){u.remove(),d&&(""==a.history.fragment?location.reload():a.router.navigate("",!0))}),u.fadeIn()},this.zeroFill=function(e,t,a){return a=a||"0",e+="",e.length>=t?e:new Array(t-e.length+1).join(a)+e},this.put=function(e,t){void 0===this.store?alert("you cannot use local store, please use a modern browser"):this.store.setItem(e,JSON.stringify(t))},this.get=function(e){return void 0!==this.store?JSON.parse(this.store.getItem(e)):void alert("you cannot use local store, please use a modern browser")},this.getBreadcrumbs=function(e,a){var s=[];return this.ajaxRequest({url:"nomenclature/getAllTypes.ws",type:"GET",success:function(r){var i=0;t.each(r,function(e){i+=e.width});var o=function(e,t){for(var a=e.length;t>a;a++)e+="#";return e};this.ajaxRequest({url:"nomenclature/readTree.ws",type:"GET",success:function(n){var l=[],d=function(e){e.value=e.data.value,e.fullKey=e.data.fullKey,l.push(e),t.each(e.children,function(e){e.value=e.data.value,l.push(e),e.children&&d(e)},this)};t.each(n,function(e){d(e)});var c="",u=0,v=0;t.each(r,function(a){v=u+a.width;var r={};c+=e.slice(u,v),r.key=e.slice(u,v),r.nomenclature=o(c,i),r.name=void 0;var n=t.findWhere(l,{value:r.key,fullKey:r.nomenclature});n&&(r.name=n.data.name),r.label=a.description,void 0!=r.name&&s.push(r),u+=a.width},this),a&&a()}})}}),s}}return new o});